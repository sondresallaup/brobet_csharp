@model Brobet.ViewModels.IndexViewModel
@{
}

@Html.Partial("_NavbarPartial")

<div class="body-container">
    <div class="day-arrows">
        <a class="previous disabled" href="javascript:void(0);"><i class="fas fa-arrow-left"></i></a>
        <a class="next" href="javascript:void(0);"><i class="fas fa-arrow-right"></i></a>
    </div>
    @{
        foreach (var fixtureD in Model.fixtures)
        {
            var fixture = fixtureD.Value;
            <div class="fixture status-@fixture.status" data-fixture-id="@fixture.id">
                <table>
                    <tr class="local-team">
                        <td class="score">
                            <span class="score-span">
                                @fixture.localTeamScore
                            </span>
                        </td>
                        <td class="logo">
                            <img src="@fixture.localTeamLogo" />
                        </td>
                        <td class="name">
                            @fixture.localTeamName
                        </td>
                        <td rowspan="2" class="time">
                            <span class="min">@fixture.minute'</span>
                            <span class="status">@fixture.status</span>
                            <span class="scheduled">@fixture.staringAtString</span>
                        </td>
                    </tr>
                    <tr class="visitor-team">
                        <td class="score">
                            <span class="score-span">
                                @fixture.visitorTeamScore
                            </span>
                        </td>
                        <td class="logo">
                            <img src="@fixture.visitorTeamLogo" />
                        </td>
                        <td class="name">
                            @fixture.visitorTeamName
                        </td>
                    </tr>
                </table>
            </div>
        }
    }
</div>


<div class="modal-background hidden">
    <div class="modal">
        <div class="friends-list-modal">
            <ul>
                @foreach(var friend in Model.friends)
                {
                    <li class="friend" data-friend-id="@friend.userId">
                        @friend.username
                    </li>
                }
                <li>
                    <a href="javascript:void(0);" class="cancel">Cancel</a>
                </li>
            </ul>
        </div>
    </div>
</div>


<script>
    var daysFromNow = @Model.daysFromNow;

    $(function () {
        window.setInterval(function () {
            updateFixtures();
        }, 10000);

        var fixtures;

        function updateFixtures() {
            $.get('/Home/GetFixturesJson?daysFromNow=@Model.daysFromNow', function (data) {
                fixtures = JSON.parse(data);
                console.log(fixtures);

                for (var key in fixtures) {
                    var fixture = fixtures[key];
                    var $fixture = $(".body-container").find(`.fixture[data-fixture-id='${fixture.id}']`);
                    $fixture.attr('class', 'fixture');
                    $fixture.addClass('status-' + fixture.status);

                    // Local team
                    var $localTeam = $fixture.find('.local-team');
                    $localTeam.find('.score .score-span').html(fixture.localTeamScore);
                    // Visitor team
                    var $visitorTeam = $fixture.find('.visitor-team');
                    $visitorTeam.find('.score .score-span').html(fixture.visitorTeamScore);

                    // Time
                    $fixture.find('.min').html(fixture.minute + "'");
                    $fixture.find('.status').html(fixture.status);
                }
            });
        }
        updateFixtures();

        if (daysFromNow > 0) {
            $('.day-arrows a.previous').removeClass('disabled');
        }


        $('.day-arrows a').click(function () {
            var $arrow = $(this);
            if ($arrow.hasClass('disabled')) return;

            if ($arrow.hasClass('next')) {
                daysFromNow++;
            }
            else {
                daysFromNow--;
            }
            location.href = '/?daysFromNow=' + daysFromNow;
        })

        $('.fixture').click(function () {
            var fixtureId = $(this).data('fixture-id');
            showModal();
        });

        $('.modal-background, .modal .friends-list-modal .cancel').click(function (e) {
            if (e.target !== e.currentTarget) return;
            hideModal();
        });
        function showModal() {
            var $this = $('.modal-background');
            $this.removeClass('hidden');
        }

        function hideModal() {
            var $this = $('.modal-background');
            $this.addClass('hidden');
        }
    });

</script>